%% Advanced RabbitMQ 4.1.x Configuration
%% This file provides advanced clustering and data safety options

[
  {rabbit, [
    %% Cluster configuration for high availability
    {cluster_nodes, {['rabbit@node1', 'rabbit@node2', 'rabbit@node3'], disc}},
    
    %% Network partition handling - critical for data safety
    {cluster_partition_handling, pause_minority},
    
    %% TCP configuration for better network resilience
    {tcp_listeners, [5672]},
    {num_tcp_acceptors, 10},
    {handshake_timeout, 10000},
    
    %% Memory management
    {vm_memory_high_watermark, 0.6},
    {vm_memory_calculation_strategy, rss},
    
    %% Disk space monitoring
    {disk_free_limit, {mem_relative, 2.0}},
    
    %% Queue configuration for data durability
    {default_queue_type, quorum},
    {quorum_commands_soft_limit, 32},
    {quorum_cluster_size, 3},
    
    %% Heartbeat and keepalive settings
    {heartbeat, 60},
    
    %% Channel limits
    {channel_max, 2048},
    
    %% Connection configuration
    {connection_max, 2048},
    
    %% Statistics collection
    {collect_statistics_interval, 5000},
    
    %% Delegate process count for cluster operations
    {delegate_count, 16},
    
    %% Queue master locator for load distribution
    {queue_master_locator, <<"min-masters">>},
    
    %% Mirroring policy for classic queues (if any remain)
    {mirroring_sync_batch_size, 4096},
    
    %% Prevent message loss during network issues
    {mnesia_table_loading_retry_timeout, 30000},
    {mnesia_table_loading_retry_limit, 10}
  ]},
  
  {rabbitmq_management, [
    %% Management plugin configuration
    {listener, [
      {port, 15672},
      {ip, "0.0.0.0"}
    ]},
    {load_definitions, "/etc/rabbitmq/definitions.json"}
  ]},
  
  {kernel, [
    %% Network kernel parameters for cluster stability
    {inet_default_connect_options, [
      {nodelay, true},
      {keepalive, true},
      {send_timeout, 15000},
      {send_timeout_close, true}
    ]},
    
    %% Distribution buffer sizes for large clusters
    {inet_dist_listen_min, 25672},
    {inet_dist_listen_max, 25672}
  ]},
  
  {mnesia, [
    %% Mnesia configuration for cluster database
    {dump_log_write_threshold, 50000},
    {dc_dump_limit, 40}
  ]}
].