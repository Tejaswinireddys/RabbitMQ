# RabbitMQ 4.1.x Configuration
# Data safety and cluster configuration

# Cluster configuration for RHEL VMs
cluster_formation.peer_discovery_backend = classic_config
cluster_formation.classic_config.nodes.1 = rabbit@node1
cluster_formation.classic_config.nodes.2 = rabbit@node2  
cluster_formation.classic_config.nodes.3 = rabbit@node3

# Node name will be set based on hostname
# Ensure hostnames are set correctly: node1, node2, node3

# Network partition handling - prevents split-brain scenarios
cluster_partition_handling = pause_minority

# Quorum queues for data durability (RabbitMQ 4.x feature)
default_queue_type = quorum

# Memory and disk thresholds
vm_memory_high_watermark.relative = 0.6
disk_free_limit.relative = 2.0

# Heartbeat configuration for better network failure detection
heartbeat = 60

# Channel and connection limits
channel_max = 2048
connection_max = 2048

# Queue master locator for better distribution
queue_master_locator = min-masters

# Enable management plugin
management.tcp.port = 15672
management.tcp.ip = 0.0.0.0

# SSL/TLS Configuration
listeners.ssl.default = 5671
ssl_options.cacertfile = /etc/rabbitmq/ca_certificate.pem
ssl_options.certfile = /etc/rabbitmq/server_certificate.pem
ssl_options.keyfile = /etc/rabbitmq/server_key.pem
ssl_options.verify = verify_peer
ssl_options.fail_if_no_peer_cert = true
ssl_options.honor_cipher_order = true
ssl_options.versions.1 = tlsv1.2
ssl_options.versions.2 = tlsv1.3

# Cipher suites for security
ssl_options.ciphers.1 = ECDHE-RSA-AES256-GCM-SHA384
ssl_options.ciphers.2 = ECDHE-ECDSA-AES256-GCM-SHA384
ssl_options.ciphers.3 = ECDHE-RSA-AES256-SHA384
ssl_options.ciphers.4 = ECDHE-ECDSA-AES256-SHA384
ssl_options.ciphers.5 = DHE-RSA-AES256-GCM-SHA384

# Logging
log.console = true
log.console.level = info
log.file = /var/log/rabbitmq/rabbit.log
log.file.level = info

# Advanced configuration for cluster stability
collect_statistics_interval = 5000
delegate_count = 16

# Prevent memory alarms during cluster operations
vm_memory_calculation_strategy = rss

# Enable plugins directory
plugins_dir = /usr/lib/rabbitmq/plugins

# Erlang cookie file location
cluster_formation.randomized_startup_delay_range.min = 5
cluster_formation.randomized_startup_delay_range.max = 60