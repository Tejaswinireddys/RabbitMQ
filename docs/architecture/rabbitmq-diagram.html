<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RabbitMQ 3.x to 4.x Architecture Visualization</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
        }
        .header-title {
            font-family: Arial, sans-serif;
            font-weight: bold;
            font-size: 16pt;
            text-align: center;
            padding: 1rem;
        }
        .component {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            padding: 1rem;
            border: 1px solid #ccc;
            border-radius: 0.5rem;
            background-color: white;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            min-height: 120px;
            justify-content: center;
            position: relative;
            transition: all 0.2s ease-in-out;
        }
        .component:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .component-icon {
            width: 48px;
            height: 48px;
            margin-bottom: 0.5rem;
        }
        .tooltip {
            visibility: hidden;
            width: 200px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 10;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.875rem;
        }
        .tooltip::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #333 transparent transparent transparent;
        }
        .has-tooltip:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }
        .progress-bar {
            width: 100%;
            background-color: #e0e0e0;
            border-radius: 0.25rem;
            overflow: hidden;
            height: 1rem;
            margin-top: 0.5rem;
        }
        .progress-bar-inner {
            height: 100%;
            text-align: center;
            color: white;
            font-size: 0.75rem;
            line-height: 1rem;
            transition: width 0.5s ease-in-out;
        }
        .status-light {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 0.5rem;
        }
        .blinking {
            animation: blinker 1.5s linear infinite;
        }
        @keyframes blinker {
            50% {
                opacity: 0.3;
            }
        }
    </style>
</head>
<body class="bg-gray-50">

    <div class="container mx-auto p-4 max-w-screen-2xl">
        <!-- Main Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-4 relative">

            <!-- Left Side: 3.x Architecture -->
            <div class="lg:col-span-5 bg-[#FFE6CC] p-4 rounded-lg shadow-lg">
                <h2 class="header-title">RabbitMQ 3.x Architecture</h2>
                <div class="space-y-6 mt-4">
                    <!-- Erlang VM -->
                    <div id="erlang3" class="component has-tooltip">
                        <svg class="component-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M5.25 14.25h13.5m-13.5 0a3 3 0 01-3-3V7.5a3 3 0 013-3h13.5a3 3 0 013 3v3.75a3 3 0 01-3 3m-13.5 0h13.5m-13.5 0a3 3 0 00-3 3v.75a3 3 0 003 3h13.5a3 3 0 003-3v-.75a3 3 0 00-3-3" /></svg>
                        <strong>Erlang VM</strong>
                        <span>(OTP 24)</span>
                        <div class="tooltip">Erlang Run-Time System, providing a robust platform for concurrent, distributed systems.</div>
                    </div>
                    <!-- Mnesia DB -->
                    <div id="mnesia3" class="component has-tooltip">
                        <svg class="component-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 6.375c0 2.278-3.694 4.125-8.25 4.125S3.75 8.653 3.75 6.375m16.5 0c0-2.278-3.694-4.125-8.25-4.125S3.75 4.097 3.75 6.375m16.5 0v11.25c0 2.278-3.694 4.125-8.25 4.125s-8.25-1.847-8.25-4.125V6.375" /></svg>
                        <strong>Mnesia Database</strong>
                        <span>Schema & Metadata</span>
                        <div class="tooltip">Distributed database management system for schema, users, permissions, and policies.</div>
                    </div>
                    <!-- Queues -->
                    <div class="p-4 rounded-lg bg-white/50">
                        <h3 class="font-bold mb-2 text-center">Queue Types</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 w-full">
                            <div id="classic3" class="component has-tooltip bg-green-100 border-green-400">
                                <svg class="component-icon text-green-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 12h16.5m-16.5 3.75h16.5M3.75 19.5h16.5M5.625 4.5h12.75a1.875 1.875 0 010 3.75H5.625a1.875 1.875 0 010-3.75z" /></svg>
                                <strong>Classic Queues</strong>
                                <div class="tooltip">Original non-replicated queue type. Fast but no high availability.</div>
                            </div>
                            <div id="mirrored3" class="component has-tooltip bg-orange-100 border-orange-400">
                                <svg class="component-icon text-orange-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" /></svg>
                                <strong>Mirrored Queues</strong>
                                <div class="tooltip">Replicated for HA, but complex and being deprecated.</div>
                            </div>
                            <div id="quorum3" class="component has-tooltip bg-blue-100 border-blue-400 col-span-1 md:col-span-2">
                                <svg class="component-icon text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75m-3-7.036A11.959 11.959 0 013.598 6 11.99 11.99 0 003 9.749c0 5.592 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.571-.598-3.751h-.152c-3.196 0-6.1-1.248-8.25-3.286zm0 13.036h.008v.008H12v-.008z" /></svg>
                                <strong>Basic Quorum Queues</strong>
                                <div class="tooltip">Modern replicated queue based on the Raft consensus algorithm.</div>
                            </div>
                        </div>
                    </div>
                     <!-- Management UI -->
                    <div id="ui3" class="component has-tooltip">
                        <svg class="component-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 17.25v1.007a3 3 0 01-.879 2.122L7.5 21h9l-1.621-.621A3 3 0 0115 18.257V17.25m6-12V15a2.25 2.25 0 01-2.25 2.25H5.25A2.25 2.25 0 013 15V5.25A2.25 2.25 0 015.25 3h13.5A2.25 2.25 0 0121 5.25z" /></svg>
                        <strong>Basic Management UI</strong>
                        <div class="tooltip">Web-based interface for monitoring and managing the broker.</div>
                    </div>
                    <!-- Performance Metrics -->
                    <div class="component bg-orange-200 border-orange-400">
                        <h3 class="font-bold">Performance Metrics (Baseline)</h3>
                        <div class="w-full mt-2">
                            <span>Throughput: ~100k msg/s</span>
                            <div class="progress-bar"><div id="pbar3-1" class="progress-bar-inner bg-orange-500" style="width: 0%;">65%</div></div>
                            <span>Latency: ~2ms</span>
                            <div class="progress-bar"><div id="pbar3-2" class="progress-bar-inner bg-orange-500" style="width: 0%;">40%</div></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Center: Migration Path -->
            <div class="lg:col-span-2 bg-[#E6F3FF] p-4 rounded-lg shadow-lg flex flex-col items-center justify-center">
                <h2 class="header-title mb-8">Migration Path</h2>
                <div class="w-full space-y-8">
                    <div class="text-center p-4 border-2 border-dashed border-blue-500 rounded-lg bg-white">
                        <h3 class="font-bold text-blue-800">Key Steps</h3>
                        <ol class="text-left list-decimal list-inside text-sm mt-2 space-y-1">
                            <li>Upgrade Erlang/OTP</li>
                            <li>Enable Feature Flags</li>
                            <li>Migrate Mirrored Queues</li>
                            <li>Upgrade RabbitMQ Nodes</li>
                            <li>Verify Performance</li>
                        </ol>
                    </div>
                    
                    <div id="breaking" class="text-center p-4 border-2 border-red-500 rounded-lg bg-red-50">
                        <div class="flex items-center justify-center text-red-700 font-bold">
                            <svg class="w-6 h-6 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126z" /></svg>
                            <h3>Breaking Changes</h3>
                        </div>
                        <ul class="text-sm mt-2 space-y-1">
                            <li class="flex items-center justify-center">
                                <span class="text-red-500 font-bold mr-2">DEPRECATED:</span> Mirrored Queues
                            </li>
                             <li class="flex items-center justify-center">
                                <span class="text-red-500 font-bold mr-2">REMOVED:</span> `rabbitmq-diagnostics observer`
                            </li>
                            <li class="flex items-center justify-center">
                                <span class="text-blue-500 font-bold mr-2">NEW:</span> Feature Flags Required
                            </li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Right Side: 4.x Architecture -->
            <div class="lg:col-span-5 bg-[#E6FFE6] p-4 rounded-lg shadow-lg">
                <h2 class="header-title">RabbitMQ 4.x Architecture</h2>
                <div class="space-y-6 mt-4">
                    <!-- Erlang VM -->
                    <div id="erlang4" class="component has-tooltip">
                        <svg class="component-icon text-green-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 7.5l3 2.25-3 2.25m4.5 0h3m-9 8.25h13.5A2.25 2.25 0 0021 18V6a2.25 2.25 0 00-2.25-2.25H5.25A2.25 2.25 0 003 6v12a2.25 2.25 0 002.25 2.25z" /></svg>
                        <strong>Enhanced Erlang VM</strong>
                        <span>(OTP 26+)</span>
                        <div class="tooltip">Optimized for performance and stability with modern language features.</div>
                    </div>
                    <!-- Mnesia DB -->
                    <div id="mnesia4" class="component has-tooltip">
                        <svg class="component-icon text-green-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path d="M11.25 4.5v15m0 0a2.25 2.25 0 01-2.25 2.25h-1.5a2.25 2.25 0 01-2.25-2.25V4.5m4.5 15a2.25 2.25 0 002.25 2.25h1.5a2.25 2.25 0 002.25-2.25V4.5m-4.5 15h4.5" /><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 6.375c0 2.278-3.694 4.125-8.25 4.125S3.75 8.653 3.75 6.375m16.5 0c0-2.278-3.694-4.125-8.25-4.125S3.75 4.097 3.75 6.375m16.5 0v11.25c0 2.278-3.694 4.125-8.25 4.125s-8.25-1.847-8.25-4.125V6.375" /></svg>
                        <strong>Optimized Mnesia</strong>
                        <span>Improved Performance</span>
                        <div class="tooltip">Schema database with performance enhancements and better cluster stability.</div>
                    </div>
                    <!-- Queues -->
                    <div class="p-4 rounded-lg bg-white/50">
                        <h3 class="font-bold mb-2 text-center">Queue Types</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 w-full">
                            <div id="classic4" class="component has-tooltip bg-green-100 border-green-400">
                                <svg class="component-icon text-green-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 12h16.5m-16.5 3.75h16.5M3.75 19.5h16.5M5.625 4.5h12.75a1.875 1.875 0 010 3.75H5.625a1.875 1.875 0 010-3.75z" /></svg>
                                <strong>Classic Queues v2</strong>
                                <div class="tooltip">Still available, but with internal improvements.</div>
                            </div>
                            <div id="mirrored4" class="component has-tooltip bg-red-100 border-red-400">
                                <svg class="component-icon text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                                <strong>Mirrored Queues (Removed)</strong>
                                <div class="tooltip">This queue type has been removed. Migrate to Quorum Queues.</div>
                            </div>
                            <div id="quorum4" class="component has-tooltip bg-blue-100 border-blue-400">
                                <svg class="component-icon text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 011.04 0l2.125 5.111a.563.563 0 00.475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 00-.182.557l1.285 5.385a.562.562 0 01-.84.61l-4.725-2.885a.563.563 0 00-.586 0L6.982 20.54a.562.562 0 01-.84-.61l1.285-5.386a.562.562 0 00-.182-.557l-4.204-3.602a.563.563 0 01.321-.988l5.518-.442a.563.563 0 00.475-.345L11.48 3.5z" /></svg>
                                <strong>Enhanced Quorum Queues</strong>
                                <div class="tooltip">Default HA queue. More resilient, higher performance, and simpler to manage.</div>
                            </div>
                            <div id="stream4" class="component has-tooltip bg-purple-100 border-purple-400">
                                <svg class="component-icon text-purple-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 4.875c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5A1.125 1.125 0 013.75 9.375v-4.5zM3.75 14.625c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5a1.125 1.125 0 01-1.125-1.125v-4.5zM13.5 4.875c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5a1.125 1.125 0 01-1.125-1.125v-4.5z" /><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 14.625c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5a1.125 1.125 0 01-1.125-1.125v-4.5z" /></svg>
                                <strong>Stream Queues</strong>
                                <div class="tooltip">New queue type for large logs and high-throughput scenarios. Supports message replay.</div>
                            </div>
                        </div>
                    </div>
                    <!-- Management UI -->
                    <div id="ui4" class="component has-tooltip">
                        <svg class="component-icon text-green-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 11-3 0m3 0a1.5 1.5 0 10-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-9.75 0h9.75" /></svg>
                        <strong>Advanced Management UI</strong>
                        <div class="tooltip">Redesigned UI with better observability, stream support, and improved metrics.</div>
                    </div>
                    <!-- Performance Metrics -->
                    <div class="component bg-green-200 border-green-400">
                        <h3 class="font-bold">Performance Metrics (Enhanced)</h3>
                        <div class="w-full mt-2">
                             <span>Throughput: >250k msg/s</span>
                            <div class="progress-bar"><div id="pbar4-1" class="progress-bar-inner bg-green-500" style="width: 0%;">85%</div></div>
                            <span>Latency: <1ms</span>
                            <div class="progress-bar"><div id="pbar4-2" class="progress-bar-inner bg-green-500" style="width: 0%;">20%</div></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- SVG Arrows Layer -->
            <svg id="arrow-canvas" class="absolute top-0 left-0 w-full h-full pointer-events-none" style="z-index: -1;"></svg>

        </div>

        <!-- Legend and Annotations -->
        <div class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-8">
            <div class="p-4 border rounded-lg shadow-md bg-white">
                <h3 class="font-bold text-lg mb-4 text-center">Legend</h3>
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div>
                        <h4 class="font-semibold mb-2">Icons</h4>
                        <ul class="space-y-2">
                            <li class="flex items-center"><svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M5.25 14.25h13.5m-13.5 0a3 3 0 01-3-3V7.5a3 3 0 013-3h13.5a3 3 0 013 3v3.75a3 3 0 01-3 3m-13.5 0h13.5m-13.5 0a3 3 0 00-3 3v.75a3 3 0 003 3h13.5a3 3 0 003-3v-.75a3 3 0 00-3-3" /></svg> Server / VM</li>
                            <li class="flex items-center"><svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 6.375c0 2.278-3.694 4.125-8.25 4.125S3.75 8.653 3.75 6.375m16.5 0c0-2.278-3.694-4.125-8.25-4.125S3.75 4.097 3.75 6.375m16.5 0v11.25c0 2.278-3.694 4.125-8.25 4.125s-8.25-1.847-8.25-4.125V6.375" /></svg> Database</li>
                            <li class="flex items-center"><svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 12h16.5m-16.5 3.75h16.5M3.75 19.5h16.5M5.625 4.5h12.75a1.875 1.875 0 010 3.75H5.625a1.875 1.875 0 010-3.75z" /></svg> Queue</li>
                        </ul>
                    </div>
                    <div>
                        <h4 class="font-semibold mb-2">Colors & Status</h4>
                        <ul class="space-y-2">
                            <li class="flex items-center"><div class="w-4 h-4 mr-2 rounded bg-green-500"></div> Normal / Enhanced</li>
                            <li class="flex items-center"><div class="w-4 h-4 mr-2 rounded bg-orange-500"></div> Legacy / Warning</li>
                            <li class="flex items-center"><div class="w-4 h-4 mr-2 rounded bg-blue-500"></div> New / Recommended</li>
                            <li class="flex items-center"><div class="w-4 h-4 mr-2 rounded bg-red-500"></div> Deprecated / Removed</li>
                            <li class="flex items-center"><span class="status-light bg-green-500 blinking"></span> Active Component</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="p-4 border rounded-lg shadow-md bg-white">
                <h3 class="font-bold text-lg mb-4 text-center">Annotations</h3>
                <ul class="space-y-2 text-sm list-disc list-inside">
                    <li><strong>Version:</strong> 1.1</li>
                    <li><strong>Date:</strong> <span id="creationDate"></span></li>
                    <li>This diagram illustrates the high-level architectural shift from RabbitMQ 3.x to 4.x.</li>
                    <li>Performance metrics are illustrative and depend on workload and hardware.</li>
                    <li>For detailed migration steps, <a href="https://www.rabbitmq.com/upgrade.html" target="_blank" class="text-blue-600 hover:underline">view the official documentation</a>.</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        document.getElementById('creationDate').textContent = new Date().toLocaleDateString();

        function drawArrow(options) {
            const { fromId, toId, color = 'gray', dashed = false, dotted = false, curve = 0, fromSide = 'right', toSide = 'left' } = options;
            
            const fromEl = document.getElementById(fromId);
            const toEl = document.getElementById(toId);
            const svg = document.getElementById('arrow-canvas');

            if (!fromEl || !toEl || !svg) return;

            const fromRect = fromEl.getBoundingClientRect();
            const toRect = toEl.getBoundingClientRect();
            const svgRect = svg.getBoundingClientRect();

            let startX, startY, endX, endY;

            // Calculate start point
            switch (fromSide) {
                case 'top': startX = fromRect.left + fromRect.width / 2; startY = fromRect.top; break;
                case 'bottom': startX = fromRect.left + fromRect.width / 2; startY = fromRect.bottom; break;
                case 'left': startX = fromRect.left; startY = fromRect.top + fromRect.height / 2; break;
                default: startX = fromRect.right; startY = fromRect.top + fromRect.height / 2; break; // right
            }

            // Calculate end point
            switch (toSide) {
                case 'top': endX = toRect.left + toRect.width / 2; endY = toRect.top; break;
                case 'bottom': endX = toRect.left + toRect.width / 2; endY = toRect.bottom; break;
                case 'right': endX = toRect.right; endY = toRect.top + toRect.height / 2; break;
                default: endX = toRect.left; endY = toRect.top + toRect.height / 2; break; // left
            }

            // Adjust for SVG container offset
            startX -= svgRect.left;
            startY -= svgRect.top;
            endX -= svgRect.left;
            endY -= svgRect.top;
            
            const controlX = startX + (endX - startX) / 2 + curve;
            const controlY = startY + (endY - startY) / 2 - curve;

            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            const d = `M ${startX} ${startY} Q ${controlX} ${controlY} ${endX} ${endY}`;
            path.setAttribute('d', d);
            path.setAttribute('stroke', color);
            path.setAttribute('fill', 'none');
            path.setAttribute('stroke-width', '2.5');
            path.setAttribute('marker-end', `url(#arrowhead-${color.replace('#','')})`);

            if (dashed) path.setAttribute('stroke-dasharray', '8, 8');
            if (dotted) path.setAttribute('stroke-dasharray', '2, 5');
            
            svg.appendChild(path);
        }

        function createMarkers() {
            const svg = document.getElementById('arrow-canvas');
            const colors = ['#4ade80', '#f97316', '#3b82f6', '#ef4444', 'gray']; // green, orange, blue, red
            const defs = svg.querySelector('defs') || document.createElementNS('http://www.w3.org/2000/svg', 'defs');
            
            colors.forEach(color => {
                 const marker = document.createElementNS('http://www.w3.org/2000/svg', 'marker');
                 marker.setAttribute('id', `arrowhead-${color.replace('#','')}`);
                 marker.setAttribute('viewBox', '0 0 10 10');
                 marker.setAttribute('refX', '8');
                 marker.setAttribute('refY', '5');
                 marker.setAttribute('markerWidth', '6');
                 marker.setAttribute('markerHeight', '6');
                 marker.setAttribute('orient', 'auto-start-reverse');
                 
                 const polygon = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
                 polygon.setAttribute('points', '0 0, 10 5, 0 10');
                 polygon.setAttribute('fill', color);
                 marker.appendChild(polygon);
                 defs.appendChild(marker);
            });
            if (!svg.querySelector('defs')) {
                svg.appendChild(defs);
            }
        }

        function drawAllArrows() {
            const svg = document.getElementById('arrow-canvas');
            svg.innerHTML = '<defs></defs>'; 
            createMarkers();

            // 3.x Internal Flow
            drawArrow({ fromId: 'erlang3', toId: 'mnesia3', color: '#4ade80', dotted: true, curve: 30, fromSide: 'bottom', toSide: 'top' });
            drawArrow({ fromId: 'mnesia3', toId: 'classic3', color: '#4ade80', curve: 30, fromSide: 'bottom', toSide: 'top' });
            drawArrow({ fromId: 'mnesia3', toId: 'mirrored3', color: '#f97316', curve: -30, fromSide: 'bottom', toSide: 'top' });
            
            // 4.x Internal Flow
            drawArrow({ fromId: 'erlang4', toId: 'mnesia4', color: '#4ade80', dotted: true, curve: 30, fromSide: 'bottom', toSide: 'top' });
            drawArrow({ fromId: 'mnesia4', toId: 'quorum4', color: '#3b82f6', curve: 30, fromSide: 'bottom', toSide: 'top' });
            drawArrow({ fromId: 'mnesia4', toId: 'stream4', color: '#8b5cf6', curve: -30, fromSide: 'bottom', toSide: 'top' });

            // Migration Paths
            drawArrow({ fromId: 'mirrored3', toId: 'breaking', color: '#f97316', dashed: true, curve: -60 });
            drawArrow({ fromId: 'breaking', toId: 'quorum4', color: '#3b82f6', dashed: true, curve: 60 });
            drawArrow({ fromId: 'quorum3', toId: 'quorum4', color: '#3b82f6', dashed: true });

            // Deprecation
            drawArrow({ fromId: 'mirrored3', toId: 'mirrored4', color: '#ef4444', curve: -20 });
        }
        
        function animateProgressBars() {
            setTimeout(() => {
                document.getElementById('pbar3-1').style.width = '65%';
                document.getElementById('pbar3-2').style.width = '40%';
                document.getElementById('pbar4-1').style.width = '85%';
                document.getElementById('pbar4-2').style.width = '20%';
            }, 300);
        }

        window.addEventListener('load', () => {
            drawAllArrows();
            animateProgressBars();
        });
        window.addEventListener('resize', drawAllArrows);

        // Add blinking status to active components
        document.getElementById('erlang4').insertAdjacentHTML('afterbegin', '<span class="status-light bg-green-500 blinking absolute top-2 right-2"></span>');
        document.getElementById('quorum4').insertAdjacentHTML('afterbegin', '<span class="status-light bg-green-500 blinking absolute top-2 right-2"></span>');
        document.getElementById('stream4').insertAdjacentHTML('afterbegin', '<span class="status-light bg-purple-500 blinking absolute top-2 right-2"></span>');
    </script>

</body>
</html>
